<template>
    <button v-if="isSupported" @click="loginWithWebAuthn">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0,0,256,256"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(2.56,2.56)"><path d="M75,83h-52c-3.866,0 -7,-3.134 -7,-7v-52c0,-3.866 3.134,-7 7,-7h52c3.866,0 7,3.134 7,7v52c0,3.866 -3.134,7 -7,7z" fill="#ede1bd"></path><path d="M17,35c-0.553,0 -1,-0.447 -1,-1v-10c0,-3.859 3.141,-7 7,-7h10c0.553,0 1,0.447 1,1c0,0.553 -0.447,1 -1,1h-10c-2.757,0 -5,2.243 -5,5v10c0,0.553 -0.447,1 -1,1z" fill="#000000"></path><path d="M33,83h-10c-3.859,0 -7,-3.141 -7,-7v-10c0,-0.553 0.447,-1 1,-1c0.553,0 1,0.447 1,1v10c0,2.757 2.243,5 5,5h10c0.553,0 1,0.447 1,1c0,0.553 -0.447,1 -1,1z" fill="#000000"></path><path d="M81,35c-0.553,0 -1,-0.447 -1,-1v-10c0,-2.757 -2.243,-5 -5,-5h-10c-0.553,0 -1,-0.447 -1,-1c0,-0.553 0.447,-1 1,-1h10c3.859,0 7,3.141 7,7v10c0,0.553 -0.447,1 -1,1z" fill="#000000"></path><path d="M75,83h-10c-0.553,0 -1,-0.447 -1,-1c0,-0.553 0.447,-1 1,-1h10c2.757,0 5,-2.243 5,-5v-10c0,-0.553 0.447,-1 1,-1c0.553,0 1,0.447 1,1v10c0,3.859 -3.141,7 -7,7z" fill="#000000"></path><path d="M60.031,74c-0.039,0 -0.079,-0.005 -0.119,-0.015c-14.771,-3.625 -21.175,-16.082 -22.63,-22.872c-0.7,-3.263 -0.086,-6.603 1.728,-9.406c1.813,-2.803 4.61,-4.732 7.875,-5.43c6.693,-1.434 13.346,2.841 14.822,9.525c0.227,0.98 1.391,4.204 6.793,4.204h3c0.276,0 0.5,0.212 0.5,0.489c0,0.276 -0.224,0.5 -0.5,0.5h-3c-6.139,0 -7.498,-3.806 -7.769,-4.972c-1.359,-6.154 -7.476,-10.085 -13.638,-8.768c-3.004,0.643 -5.576,2.417 -7.245,4.996c-1.669,2.579 -2.234,5.652 -1.59,8.654c1.407,6.562 7.6,18.605 21.891,22.111c0.269,0.065 0.433,0.336 0.366,0.604c-0.055,0.228 -0.259,0.38 -0.484,0.38z" fill="#000000"></path><path d="M50.15,51.011c-0.2,0 -0.388,-0.12 -0.465,-0.317c-0.485,-1.234 -0.666,-2.053 -0.673,-2.087c-0.059,-0.27 0.112,-0.536 0.382,-0.595c0.267,-0.058 0.536,0.111 0.595,0.381c0.002,0.008 0.174,0.783 0.627,1.936c0.101,0.257 -0.025,0.547 -0.283,0.648c-0.06,0.023 -0.122,0.034 -0.183,0.034z" fill="#000000"></path><path d="M68.5,63c-9.704,0 -14.762,-5.02 -17.298,-9.231c-0.142,-0.236 -0.065,-0.544 0.171,-0.687c0.237,-0.139 0.544,-0.066 0.687,0.171c2.401,3.99 7.203,8.747 16.44,8.747c0.276,0 0.5,0.224 0.5,0.5c0,0.276 -0.224,0.5 -0.5,0.5z" fill="#000000"></path><path d="M49.498,63.935c-0.122,0 -0.244,-0.044 -0.34,-0.134c-5.868,-5.441 -7.581,-11.728 -7.966,-13.525c-0.477,-2.219 -0.059,-4.49 1.175,-6.396c1.233,-1.905 3.135,-3.216 5.355,-3.692c4.556,-0.974 9.077,1.933 10.08,6.477c0.283,1.22 2.131,7.335 10.698,7.335h4c0.276,0 0.5,0.218 0.5,0.494c0,0.276 -0.224,0.5 -0.5,0.5h-4c-9.324,0 -11.36,-6.755 -11.674,-8.109c-0.886,-4.014 -4.875,-6.578 -8.896,-5.72c-1.959,0.42 -3.637,1.577 -4.725,3.258c-1.089,1.682 -1.457,3.686 -1.037,5.644c0.762,3.555 3.176,8.837 7.668,13.002c0.203,0.187 0.214,0.504 0.027,0.706c-0.097,0.106 -0.231,0.16 -0.365,0.16z" fill="#000000"></path><path d="M66.501,70.924c-0.01,0 -0.02,0 -0.029,-0.001c-5.367,-0.313 -10.163,-1.889 -14.255,-4.682c-0.228,-0.156 -0.286,-0.467 -0.131,-0.695c0.156,-0.228 0.468,-0.284 0.695,-0.131c3.94,2.69 8.566,4.207 13.749,4.51c0.275,0.016 0.486,0.253 0.47,0.528c-0.016,0.266 -0.236,0.471 -0.499,0.471z" fill="#000000"></path><path d="M67.5,67c-0.005,0 -0.011,0 -0.017,0c-14.828,-0.494 -21.116,-11.696 -22.369,-17.552c-0.52,-2.429 1.03,-4.828 3.455,-5.348c2.409,-0.518 4.802,1.024 5.334,3.433c0.151,0.656 1.666,6.525 7.795,9.17c0.253,0.109 0.37,0.404 0.261,0.658c-0.109,0.253 -0.407,0.37 -0.657,0.261c-6.58,-2.84 -8.21,-9.157 -8.373,-9.868c-0.414,-1.878 -2.276,-3.072 -4.15,-2.676c-0.913,0.196 -1.696,0.737 -2.204,1.523c-0.507,0.785 -0.679,1.722 -0.484,2.637c1.196,5.59 7.215,16.289 21.425,16.761c0.276,0.01 0.492,0.24 0.483,0.517c-0.008,0.271 -0.231,0.484 -0.499,0.484z" fill="#000000"></path><path d="M71.501,59h-1.002c-0.276,0 -0.499,-0.224 -0.499,-0.5c0,-0.276 0.223,-0.5 0.499,-0.5h1.002c0.276,0 0.499,0.224 0.499,0.5c0,0.276 -0.223,0.5 -0.499,0.5z" fill="#000000"></path><path d="M67.499,58.974c-0.008,0 -0.016,0 -0.023,-0.001c-0.696,-0.032 -1.385,-0.099 -2.049,-0.198c-0.273,-0.04 -0.462,-0.297 -0.421,-0.572c0.04,-0.275 0.3,-0.464 0.567,-0.425c0.631,0.094 1.285,0.157 1.949,0.188c0.275,0.013 0.488,0.248 0.475,0.527c-0.011,0.271 -0.233,0.481 -0.498,0.481z" fill="#000000"></path><path d="M68.583,42.977c-0.213,0 -0.41,-0.136 -0.477,-0.35c-0.194,-0.616 -0.435,-1.25 -0.735,-1.939c-0.11,-0.253 0.005,-0.548 0.258,-0.658c0.253,-0.109 0.548,0.004 0.658,0.258c0.315,0.722 0.568,1.389 0.772,2.04c0.083,0.263 -0.063,0.544 -0.326,0.627c-0.049,0.015 -0.1,0.022 -0.15,0.022z" fill="#000000"></path><path d="M66.205,37.986c-0.162,0 -0.321,-0.079 -0.417,-0.224c-3.205,-4.85 -8.565,-8.097 -14.338,-8.686c-0.274,-0.028 -0.475,-0.274 -0.446,-0.549c0.028,-0.275 0.274,-0.471 0.548,-0.447c6.068,0.62 11.701,4.033 15.07,9.13c0.152,0.231 0.089,0.541 -0.142,0.693c-0.084,0.056 -0.18,0.083 -0.275,0.083z" fill="#000000"></path><path d="M41.629,73c-0.121,0 -0.243,-0.044 -0.338,-0.132c-6.911,-6.363 -10.641,-14.551 -11.828,-20.094c-1.148,-5.353 -0.142,-10.835 2.832,-15.436c2.977,-4.6 7.564,-7.765 12.917,-8.912c1.06,-0.227 2.159,-0.371 3.264,-0.426c0.27,-0.018 0.509,0.198 0.523,0.475c0.014,0.276 -0.198,0.511 -0.473,0.525c-1.052,0.052 -2.097,0.189 -3.105,0.404c-5.091,1.091 -9.455,4.102 -12.287,8.477c-2.83,4.376 -3.786,9.59 -2.695,14.683c1.155,5.391 4.79,13.363 11.527,19.566c0.204,0.188 0.216,0.504 0.029,0.707c-0.096,0.108 -0.231,0.163 -0.366,0.163z" fill="#000000"></path><path d="M71.75,39.998c-0.197,0 -0.385,-0.118 -0.463,-0.312c-1.485,-3.659 -3.94,-6.927 -7.099,-9.45c-0.215,-0.172 -0.251,-0.487 -0.078,-0.703c0.173,-0.216 0.487,-0.251 0.703,-0.079c3.292,2.63 5.851,6.038 7.4,9.855c0.104,0.256 -0.019,0.547 -0.274,0.651c-0.062,0.026 -0.126,0.038 -0.189,0.038z" fill="#000000"></path><path d="M35.168,72c-0.143,0 -0.285,-0.061 -0.383,-0.179c-4.484,-5.342 -7.935,-12.147 -9.232,-18.203c-1.372,-6.396 -0.17,-12.946 3.385,-18.442c3.558,-5.497 9.04,-9.278 15.438,-10.647c5.881,-1.262 12.05,-0.251 17.376,2.841c0.239,0.139 0.32,0.445 0.182,0.684c-0.14,0.239 -0.446,0.319 -0.684,0.182c-5.112,-2.968 -11.031,-3.937 -16.664,-2.728c-6.137,1.314 -11.395,4.941 -14.808,10.213c-3.41,5.271 -4.564,11.554 -3.248,17.69c1.265,5.903 4.637,12.546 9.02,17.769c0.178,0.211 0.15,0.526 -0.062,0.704c-0.093,0.078 -0.207,0.116 -0.32,0.116z" fill="#000000"></path><path d="M33.783,46.008c-0.031,0 -0.063,-0.003 -0.094,-0.009c-0.271,-0.052 -0.45,-0.313 -0.398,-0.584c0.398,-2.097 1.192,-4.075 2.36,-5.88c2.396,-3.7 6.088,-6.246 10.397,-7.168c8.841,-1.896 17.621,3.747 19.569,12.574c0.018,0.072 0.07,0.227 0.132,0.383c0.102,0.257 -0.024,0.547 -0.281,0.649c-0.258,0.099 -0.548,-0.024 -0.648,-0.282c-0.083,-0.209 -0.151,-0.419 -0.177,-0.526c-1.832,-8.299 -10.076,-13.597 -18.385,-11.821c-4.048,0.867 -7.516,3.258 -9.767,6.734c-1.097,1.696 -1.843,3.554 -2.217,5.524c-0.046,0.239 -0.256,0.406 -0.491,0.406z" fill="#000000"></path><path d="M49.586,74c-0.088,0 -0.178,-0.023 -0.259,-0.072c-0.298,-0.181 -0.584,-0.371 -0.869,-0.561l-0.234,-0.155c-0.23,-0.152 -0.293,-0.463 -0.141,-0.692c0.152,-0.23 0.462,-0.296 0.693,-0.142l0.237,0.157c0.274,0.183 0.547,0.365 0.833,0.538c0.236,0.144 0.312,0.45 0.168,0.686c-0.094,0.155 -0.259,0.241 -0.428,0.241z" fill="#000000"></path><path d="M39.81,65.002c-0.153,0 -0.304,-0.07 -0.402,-0.202c-2.937,-3.967 -5.137,-8.65 -6.037,-12.85c-0.156,-0.726 -0.257,-1.493 -0.317,-2.411c-0.018,-0.275 0.19,-0.514 0.466,-0.532c0.269,-0.015 0.514,0.19 0.532,0.466c0.057,0.868 0.151,1.589 0.297,2.268c0.872,4.064 3.008,8.608 5.863,12.464c0.165,0.223 0.118,0.535 -0.104,0.7c-0.091,0.065 -0.195,0.097 -0.298,0.097z" fill="#000000"></path><path d="M45.5,71.062c-0.113,0 -0.227,-0.038 -0.32,-0.116c-1.109,-0.927 -2.203,-1.972 -3.25,-3.106c-0.188,-0.202 -0.175,-0.518 0.028,-0.706c0.202,-0.187 0.518,-0.178 0.707,0.028c1.033,1.117 2.065,2.103 3.157,3.016c0.212,0.178 0.24,0.493 0.063,0.704c-0.1,0.12 -0.242,0.18 -0.385,0.18z" fill="#000000"></path></g></g></svg>
    </button>
</template>
<script setup>
    import { ref, onMounted } from 'vue'
    import { sendApi } from '@/utils/api'
    import router from '@/router'
    const isSupported = ref(false)
    onMounted(() => {
        isSupported.value = window.PublicKeyCredential && typeof window.PublicKeyCredential === 'function'
    })
    async function loginWithWebAuthn() {
        try {
            const res = await sendApi({
                action: 'login_webauthn_request',
                control:'login'
            })
            if (!res || !res.publicKey) {
                if (res.status === 'error') {
                    alert(res.message)
                } else {
                    throw new Error('مشکلی در دریافت challenge رخ داد.')
                }
                return
            }
            const options = preformatGetReq(res.publicKey)
            const assertion = await navigator.credentials.get({
                publicKey: options
            })
            const verify = await sendApi({
                action: 'login_webauthn_response',
                data:assertion,
                control:'login'
            })
            if (verify.status==='success') {
                if (verify.url === 'dashboard') {
                    router.push({ name: 'dashboard' })
                } else if (verify.url === 'register') {
                    router.push({ name: 'register' })
                } else {
                    this.message = 'مشخصات ناقص است. لطفاً دوباره تلاش کنید.'
                }
            } else {
                alert('احراز هویت ناموفق بود.')
            }
        } catch (err) {
            console.error(err)
            alert('خطا در ورود با اثر انگشت')
        }
    }
    function decodeMimeBase64(mimeString) {
        const match = mimeString.match(/=\?BINARY\?B\?(.*)\?=/i)
        if (match && match[1]) {
        return Uint8Array.from(atob(match[1]), c => c.charCodeAt(0)).buffer
        }
        return Uint8Array.from(atob(mimeString), c => c.charCodeAt(0)).buffer
    }
    function preformatGetReq(options) {
        const opts = { ...options }
        opts.challenge = decodeMimeBase64(opts.challenge)
        if (opts.allowCredentials && Array.isArray(opts.allowCredentials)) {
            opts.allowCredentials = opts.allowCredentials.map(cred => ({
            ...cred,
            id: decodeMimeBase64(cred.id)
            }))
        }
        return opts
    }
</script>
<style scoped>
    button{
        border: none;
        outline: none;
        width: 40px;
        height: 40px;
        cursor: pointer;
        padding: 0;
        background: transparent;
    }
    svg{
        height: 100%;
        width: 100%;
    }
</style>